---
title: "Preoperative Atelectasis"
subtitle: "Part 1: Overview, selection criteria, and missing data"
author: "Javier Mancilla Galindo"
date: last rendered on "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: default
    highlight: pygments
---

# Setup 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # show both code and output by default
knitr::opts_chunk$set(warning = FALSE) # hides all warnings
knitr::opts_chunk$set(message = FALSE) # hides all package message
```

#### Packages used    
```{r}
if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

pacman::p_load(
  tidyverse, # Used for basic data handling and visualization.
  overviewR, # Used to assess missing data.
  table1 #Used to add labels to variables.
)
```

##### Session info  
```{r, echo=FALSE}
# Credits chunk of code: Alex Bossers, Utrecht University (a.bossers@uu.nl)

# remove clutter
session <- sessionInfo()
session$BLAS <- NULL
session$LAPACK <- NULL
session$loadedOnly <- NULL
# write log file
writeLines(
  capture.output(print(session, locale = FALSE)),
  paste0(lubridate::today(), "_session_Part_1.txt")
)

session
```

```{r, include=FALSE}
rm(session)
```

```{r, include=FALSE}
# Create directories for sub-folders  
psfolder <- "../data/processed"
source_docs <- "../docs/source"
dir.create(psfolder, showWarnings = FALSE)
dir.create(psfolder, showWarnings = FALSE)
```

```{r, include=FALSE}
# Load dataset  
data <- read.csv("../data/raw/atelectasis_prevalence.csv",
                 na.strings="NA", 
                 row.names = NULL)
```

```{r, include=FALSE}
# Recode variables  
source("variable_names_attributes_raw.R", local = knitr::knit_global())
```

```{r, include=FALSE}
str(data)
```


# General overview  
```{r}
summary(data)
```

### Exclude participants with CO-RADS â‰¥ 3:   
    
Participants with higher probability of having a current diagnosis of COVID-19 are expected to have chest CT alterations due to COVID-19 pneumonia. Thus, will be excluded.   
    
Number of patients according to CO-RADS:  
```{r}
summary(data$CORADS)
```

```{r}
count(data)
```

```{r}
data <- data %>%
  filter(as.numeric(CORADS) < 3) %>%
  droplevels(data$CORADS)

count(data)
```

### Exclude participants with prior COVID-19:   
    
Since prior COVID-19 is considered a confounder and since there are only 3 participants with prior COVID-19 which would provide difficult to assess the role of prior COVID-19 in analyses, participants with prior COVID-19 were excluded from the analysis.  
    
```{r}
count(data)
```

```{r}
data <- data %>%
  filter(prior_covid19 == "No") %>%
  droplevels(data$prior_covid19)

count(data)
```

Will remove prior_covid19 column as it no longer provides information of a varying characteristic. Similarly, rapid_covid_test does not provide additional information.   
```{r}
length(data)
```


```{r}
data <- data %>% select(-c(prior_covid19, rapid_covid_test))

length(data)
```


# Missing data per variable     
```{r}
overview_na(data)
```

Missing data for PCR_covid and is explained since only patients who decided to have a test performed on their own will reported the result. The medical center did not require a negative PCR test at that time during the pandemic, reason why PCR tests were not systematically performed. As shown in earlier summary of variables, all available tests (n=3) were negative. This variable will not be analyzed further downstream:    

```{r}
data <- data %>% select(-PCR_covid)
```

The variable atelectasis_location has missing data since those patients who did not have atelectasis naturally do not have a location recorded. Will assess if data are missing for those who had atelectasis:  
```{r}
data %>%
  filter(atelectasis == "Yes") %>%
  group_by(atelectasis_location) %>%
  overview_na()
```

There is no missing data for ***atelectasis_location*** after sub-setting only those who had atelectasis.  

Lastly, I will subset all participants without the prior variable to further assess the extent of missing data for other variables:     

```{r}
data %>%
  select(-c(atelectasis_location)) %>%
  overview_na()
```

Missing data constitutes **less than 5%** for all remaining variables. Thus, will proceed with **complete-case analysis** without performing any data imputation procedure.  

```{r, include=FALSE}
#Save dataset
write.csv(data, 
          file = paste0(psfolder,"/atelectasis_included.csv"),
          row.names=FALSE)
```

```{r, include=FALSE}
rm(data, figfolder, psfolder, tabfolder)
pacman::p_unload(negate = TRUE)
```

